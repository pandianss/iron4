"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.dependencyRule = dependencyRule;
const Elements_1 = require("../../Elements");
const Settings_1 = require("../../Settings");
const Support_1 = require("../../Support");
const Helpers_1 = require("./Helpers");
const { ADDITIONAL_DEPENDENCY_NODES } = Settings_1.SETTINGS;
function optionsHaveRules(options) {
    if (!options) {
        return false;
    }
    return Boolean(options.rules);
}
function dependencyRule(ruleMeta, rule, ruleOptions = {}) {
    return {
        ...(0, Helpers_1.meta)(ruleMeta),
        create: function (context) {
            const options = context.options[0];
            const settings = (0, Settings_1.getSettings)(context);
            const file = (0, Elements_1.elementDescription)(context.filename, settings);
            if (ruleOptions.validate !== false && !options) {
                return {};
            }
            if (ruleOptions.validate !== false && optionsHaveRules(options)) {
                (0, Settings_1.validateRules)(settings, options.rules, ruleOptions.validateRules);
            }
            // TODO: Remove this check when allowing to select by any other property
            if (file.isIgnored || !file.type) {
                return {};
            }
            return settings.dependencyNodes.reduce((visitors, { selector, kind, name }) => {
                visitors[selector] = (node) => {
                    if (!(0, Support_1.isString)(node.value)) {
                        (0, Support_1.warnOnce)(`Dependency node is not a Literal, skipping node. Please check your ${ADDITIONAL_DEPENDENCY_NODES} setting.`);
                        return;
                    }
                    const dependency = (0, Elements_1.dependencyDescription)({
                        node,
                        kind,
                        nodeKind: name,
                    }, context.filename, settings, context);
                    rule({ dependency, options, node, context, settings });
                };
                return visitors;
            }, {});
        },
    };
}
